#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start feed watchdog service
# ==============================================================================

echo "Starting feed watchdog ..."
stopfile=/run/stopfeeds
killed=0

while [ 1 ] ; do
    listeners=$(netstat -tpn | grep ffserver | grep -v "127.0.0.1" || /bin/true 2>&1)
    if [[ -n "$listeners" ]] ; then
        rm $stopfile 2>&1 || /bin/true
        killed=0
    elif [ $killed -eq 0 ] ; then
        touch $stopfile || /bin/true
        killall ffmpeg || /bin/true
        killed=1
    else
        touch $stopfile || /bin/true
    fi

    sleep 0.1s
done

echo "feed watchdog exited, errorcode: $?"
